<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Hello, World!</title>
  <style type="text/css">
    textarea {
      height: 3em;
      width: 100%;
    }

    #send {
      margin-top: 0.5em;
      width: 15em;
    }

    .input-line {
      display: flex;
    }

    #event-log {
      border: 1px dotted black;
      font-family: monospace;
      height: 12em;
      overflow: scroll;
      padding-bottom: 1em;
      padding-top: 1em;
    }

    .log-error {
      color: darkred;
    }
  </style>
</head>

<body>
  <div>
    <h2>Send data over WebTransport</h2>
    <form name="sending">
      <textarea name="data" id="data">hello</textarea>
      <input type="button" id="send" name="send" value="Send data" disabled onclick="sendData()">
    </form>
  </div>
  <div>
    <h2>Event log</h2>
    <ul id="event-log">
    </ul>
  </div>
  <script>
    window.onload = async () => {
      try {
        var transport = new WebTransport("https://localhost:5059/echo", {
          "serverCertificateHashes": [{
            "algorithm": "sha-256",
            "value": new Uint8Array(%%CERTHASH%%)
          }]
        });
        addToEventLog("Initiating connection...");
      } catch (e) {
        addToEventLog("Failed to create connection object. " + e, "error");
        return;
      }

      try {
        await transport.ready;
        addToEventLog("Connection ready.");
      } catch (e) {
        addToEventLog("Connection failed. " + e, "error");
        return;
      }

    }
    async function sendData() {
      let form = document.forms.sending.elements;
      let encoder = new TextEncoder("utf-8");
      let rawData = sending.data.value;
      let data = encoder.encode(rawData);
      let transport = currentTransport;
      try {
        switch (form.sendtype.value) {
          case "datagram":
            await currentTransportDatagramWriter.write(data);
            addToEventLog("Sent datagram: " + rawData);
            break;
          case "unidi": {
            let stream = await transport.createUnidirectionalStream();
            let writer = stream.getWriter();
            await writer.write(data);
            await writer.close();
            addToEventLog("Sent a unidirectional stream with data: " + rawData);
            break;
          }
          case "bidi": {
            let stream = await transport.createBidirectionalStream();
            let number = streamNumber++;
            readFromIncomingStream(stream, number);

            let writer = stream.writable.getWriter();
            await writer.write(data);
            await writer.close();
            addToEventLog(
              "Opened bidirectional stream #" + number +
              " with data: " + rawData,
            );
            break;
          }
        }
      } catch (e) {
        addToEventLog("Error while sending data: " + e, "error");
      }
    }

    function addToEventLog(text, severity = "info") {
      let log = document.getElementById("event-log");
      let mostRecentEntry = log.lastElementChild;
      let entry = document.createElement("li");
      entry.innerText = text;
      entry.className = "log-" + severity;
      log.appendChild(entry);
      if (
        mostRecentEntry != null &&
        mostRecentEntry.getBoundingClientRect().top <
        log.getBoundingClientRect().bottom
      ) {
        log.scrollTop = log.scrollHeight;
      }
    }
  </script>
</body>

</html>